#!/bin/bash

#----------------------------------------------------------------
#
#    DESCRIPTION: Telegram weather bot
#         AUTHOR: Kioller Alexey
#         E-MAIL: avkioller@gmail.com
#           DATE: 07.07.2017
#
#----------------------------------------------------------------

#==========VARIABLES========================================================

             KEY="$1"
     WEATHER_KEY="$2"        # https://www.worldweatheronline.com/
         TIMEOUT="10"
             URL="https://api.telegram.org/bot$KEY"
         BOTNAME="@$( curl -s "$URL/getMe" |     \
                      jq .result.username  | tr -d '"' )"

#==========FUNCTIONS========================================================

function _send_text {
    curl -s --max-time "$TIMEOUT"                                       \
            --output /dev/null                                          \
            -d "chat_id=$CHAT_ID&disable_web_page_preview=1&text=$TEXT" \
            "$URL/sendMessage"
}

function _weather_request {
curl -s $( tr -d " \n" <<< \
                 "https://api.worldweatheronline.com/premium/v1/weather.ashx?
                              q=${LOCATION:="Ленинград"}&
                              key=$WEATHER_KEY&
                              format=json&
                              date=today&
                              fx24=yes&
                              lang=ru" )
}

#===========================================================================


while sleep 1;
do
    RAW_MESSAGE=$( curl -s "$URL/getUpdates?offset=-1" )
     MESSAGE_ID=$( jq .result[0].message.message_id    <<< "$RAW_MESSAGE" )
        CHAT_ID=$( jq .result[0].message.chat.id       <<< "$RAW_MESSAGE" )
        MESSAGE=$( jq .result[0].message.text          <<< "$RAW_MESSAGE" | sed 's/^"\|"$//g' | sed "/^\//s/$BOTNAME//" )
       LOCATION=$( sed -r "s/\/weather($BOTNAME)? ?//" <<< "$MESSAGE"     | sed 's/\s/%2B/g' )
        MESSAGE=$( sed 's/ .*//'                       <<< "$MESSAGE" )
         SENDER=$( jq .result[0].message.from.username <<< "$RAW_MESSAGE" | tr -d '"' )

    if [[ "$MESSAGE_ID" -ne "$LAST_ID" ]] 
    then
        case "$MESSAGE" in

            /weather)

                RAW_WEATHER="$( _weather_request )"
                       TEMP=$( jq .data.current_condition[0].temp_C           <<< "$RAW_WEATHER" | sed 's/^"\|"$//g' | sed '/^[0-9]/s/^/%2B/')
                    COMMENT=$( jq .data.current_condition[0].lang_ru[0].value <<< "$RAW_WEATHER" | sed 's/^"\|"$//g' )
                       CITY=$( jq .data.request[0].query                      <<< "$RAW_WEATHER" | sed 's/^"\|"$//g' )
                UPDATE_TIME=$( jq .data.current_condition[0].observation_time <<< "$RAW_WEATHER" | sed 's/^"\|"$//g' | xargs -i date -d "TZ=\"UTC\" {}" +"%H:%M" )
                if [ "$CITY" == "null" -o "$CITY" == "" ] 
                then
                    TEXT="Wrong location!"
                else

                    TEXT="[$UPDATE_TIME]: $TEMP $COMMENT%0A$CITY"
                fi

                _send_text && sed 's/%2B/+/g' <<<                             \
                             "$( date +"[%H:%M]: \"" )${TEXT//%0A/ }\" to @$SENDER"
                ;;

            /start|/info)

                TEXT=$( sed 's/^\s\+//' <<< \
                     "This is my first bot on Bash.
                      You can see the code here https://github.com/Cuttlerat/bashbot
                      by @Cuttlerat" )
                _send_text
                ;;

        esac
        LAST_ID="$MESSAGE_ID"
    fi
done
